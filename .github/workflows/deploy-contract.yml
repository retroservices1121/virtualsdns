# .github/workflows/deploy-contract.yml
name: ðŸš€ Deploy VirtualsBase Smart Contract

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'base-sepolia'
        type: choice
        options:
        - base-sepolia
        - base-mainnet
      verify:
        description: 'Verify contract on BaseScan'
        required: true
        default: true
        type: boolean
      secure_premium_names:
        description: 'Secure premium domain portfolio'
        required: true
        default: true
        type: boolean

jobs:
  deploy:
    name: ðŸ—ï¸ Deploy Smart Contract
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci --legacy-peer-deps
        
    - name: ðŸ” Create Environment File
      run: |
        echo "PRIVATE_KEY=${{ secrets.PRIVATE_KEY }}" >> .env
        echo "BASESCAN_API_KEY=${{ secrets.BASESCAN_API_KEY }}" >> .env
        echo "Network: ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ—ï¸ Compile Smart Contracts
      run: |
        npm run compile
        echo "âœ… Contracts compiled successfully" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸš€ Deploy Contract
      id: deploy
      run: |
        echo "ðŸš€ Deploying to ${{ github.event.inputs.network }}..." >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.network }}" = "base-mainnet" ]; then
          npm run deploy:mainnet > deployment-output.txt 2>&1
        else
          npm run deploy:testnet > deployment-output.txt 2>&1
        fi
        
        # Extract contract address from output
        CONTRACT_ADDRESS=$(grep -oP 'Contract deployed to: \K0x[a-fA-F0-9]{40}' deployment-output.txt || echo "")
        
        if [ -n "$CONTRACT_ADDRESS" ]; then
          echo "contract_address=$CONTRACT_ADDRESS" >> $GITHUB_OUTPUT
          echo "âœ… **Contract Address:** \`$CONTRACT_ADDRESS\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Failed to extract contract address" >> $GITHUB_STEP_SUMMARY
          cat deployment-output.txt >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
    - name: ðŸ” Verify Contract
      if: ${{ github.event.inputs.verify == 'true' }}
      run: |
        echo "ðŸ” Verifying contract on BaseScan..." >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.network }}" = "base-mainnet" ]; then
          npm run verify:mainnet || echo "âš ï¸ Verification failed - can be done manually"
        else
          npm run verify:testnet || echo "âš ï¸ Verification failed - can be done manually"
        fi
        
        echo "âœ… Contract verification completed" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“Š Upload Deployment Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-artifacts-${{ github.event.inputs.network }}
        path: |
          deployment-info.json
          .env.production
          DEPLOYMENT.md
          deployment-output.txt
        retention-days: 30
        
    - name: ðŸ“ Create Deployment Summary
      if: success()
      run: |
        echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Contract Address:** \`${{ steps.deploy.outputs.contract_address }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Verified:** ${{ github.event.inputs.verify }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Premium Names Secured:** ${{ github.event.inputs.secure_premium_names }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "deployment-info.json" ]; then
          TOTAL_NAMES=$(jq -r '.premiumNames.totalSecured // 0' deployment-info.json)
          PORTFOLIO_VALUE=$(jq -r '.portfolio.estimatedTotalValue // 0' deployment-info.json)
          
          echo "### ðŸ’Ž Premium Portfolio" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Domains Secured:** $TOTAL_NAMES" >> $GITHUB_STEP_SUMMARY
          echo "- **Estimated Portfolio Value:** \$$(echo $PORTFOLIO_VALUE | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "### ðŸ”— Important Links" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.network }}" = "base-mainnet" ]; then
          echo "- [ðŸ“Š BaseScan](https://basescan.org/address/${{ steps.deploy.outputs.contract_address }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "- [ðŸ“Š BaseScan Testnet](https://sepolia.basescan.org/address/${{ steps.deploy.outputs.contract_address }})" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- [ðŸ”— Add to MetaMask](${{ steps.deploy.outputs.contract_address }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âš¡ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. ðŸ”§ **Update Vercel Environment Variable:**" >> $GITHUB_STEP_SUMMARY
        echo "   \`REACT_APP_REGISTRY_ADDRESS=${{ steps.deploy.outputs.contract_address }}\`" >> $GITHUB_STEP_SUMMARY
        echo "2. ðŸš€ **Redeploy Frontend** on Vercel" >> $GITHUB_STEP_SUMMARY
        echo "3. ðŸ§ª **Test Domain Registration** end-to-end" >> $GITHUB_STEP_SUMMARY
        echo "4. ðŸ“¢ **Announce Launch** to community" >> $GITHUB_STEP_SUMMARY
        
  post-deploy:
    name: ðŸ“‹ Post-Deployment Tasks
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ðŸ“¥ Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: deployment-artifacts-${{ github.event.inputs.network }}
        
    - name: ðŸ“Š Display Portfolio Summary
      if: github.event.inputs.secure_premium_names == 'true'
      run: |
        if [ -f "deployment-info.json" ]; then
          echo "## ðŸ’Ž Premium Domain Portfolio Secured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract category data
          SINGLE_CHARS=$(jq -r '.premiumNames.categories.singleChars.count // 0' deployment-info.json)
          AI_KEYWORDS=$(jq -r '.premiumNames.categories.aiKeywords.count // 0' deployment-info.json)
          POPULAR_NAMES=$(jq -r '.premiumNames.categories.popularNames.count // 0' deployment-info.json)
          BUSINESS_TERMS=$(jq -r '.premiumNames.categories.businessTerms.count // 0' deployment-info.json)
          
          echo "| Category | Count | Est. Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Single Characters | $SINGLE_CHARS | \$$(echo $((SINGLE_CHARS * 100000)) | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta') |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Keywords | $AI_KEYWORDS | \$$(echo $((AI_KEYWORDS * 50000)) | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta') |" >> $GITHUB_STEP_SUMMARY
          echo "| Popular Names | $POPULAR_NAMES | \$$(echo $((POPULAR_NAMES * 10000)) | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta') |" >> $GITHUB_STEP_SUMMARY
          echo "| Business Terms | $BUSINESS_TERMS | \$$(echo $((BUSINESS_TERMS * 25000)) | sed ':a;s/\B[0-9]\{3\}\>/,&/;ta') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸŽ¯ Create Issue for Frontend Update
      uses: actions/github-script@v7
      with:
        script: |
          const contractAddress = '${{ needs.deploy.outputs.contract_address }}';
          const network = '${{ github.event.inputs.network }}';
          
          const issueBody = `
          ## ðŸš€ Smart Contract Deployed Successfully!
          
          The VirtualsBase smart contract has been deployed to **${network}**.
          
          ### ðŸ“‹ Deployment Details
          - **Contract Address:** \`${contractAddress}\`
          - **Network:** ${network}
          - **Deployed:** ${new Date().toISOString()}
          
          ### âš¡ Required Actions
          
          #### 1. Update Vercel Environment Variables
          \`\`\`
          REACT_APP_REGISTRY_ADDRESS=${contractAddress}
          \`\`\`
          
          #### 2. Redeploy Frontend
          - Go to [Vercel Dashboard](https://vercel.com/dashboard)
          - Trigger a new deployment
          
          #### 3. Test Full System
          - [ ] Connect wallet
          - [ ] Check domain availability
          - [ ] Register a test domain
          - [ ] Verify admin dashboard
          - [ ] Test transfer functionality
          
          ### ðŸ”— Links
          - [ðŸ“Š Contract on BaseScan](https://${network === 'base-mainnet' ? '' : 'sepolia.'}basescan.org/address/${contractAddress})
          - [ðŸŽ¯ Vercel Dashboard](https://vercel.com/dashboard)
          - [ðŸ“± Frontend](https://virtualsdns.fun)
          
          **Created by:** GitHub Actions deployment workflow
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš€ Update Frontend - Contract Deployed to ${network}`,
            body: issueBody,
            labels: ['deployment', 'frontend', 'action-required']
          });
